#!/usr/bin/env fish

# Jekyll site management script

function serve
    echo "Starting Jekyll development server..."
    if pgrep -f "ruby.*jekyll" > /dev/null
        echo "ERROR: Jekyll seems to be running already."
        return 1
    end
    bundle exec jekyll serve --livereload --trace --drafts --future --config _config.yml,_config-local.yml
end

function clean
    echo "Cleaning Jekyll site..."
    bundle exec jekyll clean --trace
end

function build
    echo "Building Jekyll site..."
    if pgrep -f "ruby.*jekyll" > /dev/null
        echo "ERROR: Jekyll seems to be running already."
        return 1
    end
    bundle exec jekyll build --trace
end

function check_localhost
    echo "Checking for localhost references..."
    if grep -r "localhost:4000" _site/**/*.html > /dev/null 2>&1
        echo "ERROR: Found 'localhost' in HTML files, not uploading!"
        return 1
    else
        echo "     Check passed: No 'localhost' found."
        return 0
    end
end

function upload
    echo "Uploading site to VPS..."

    # Check for localhost references first
    if not check_localhost
        return 1
    end

    echo "Syncing files to VPS..."
    rsync -avz --zc=zstd --delete _site/ root@138.199.216.195:/var/www/slama.dev/

    echo "Setting proper permissions..."
    ssh root@138.199.216.195 'chown -R www-data:www-data /var/www/slama.dev/ && chmod -R 755 /var/www/slama.dev/'

    echo "Upload complete!"
end

# Main script logic
switch $argv[1]
    case "serve"
        serve
    case "clean"
        clean
    case "build"
        build
    case "upload"
        upload
    case "all"
        build && upload
    case ""
        build && upload
    case "*"
        echo "Usage: ./site [serve|clean|build|upload|all]"
        echo ""
        echo "Commands:"
        echo "  serve   - Start development server with drafts and future posts"
        echo "  clean   - Clean generated files"
        echo "  build   - Build the site"
        echo "  upload  - Check for localhost and upload to VPS"
        echo "  all     - Build and upload"
end
